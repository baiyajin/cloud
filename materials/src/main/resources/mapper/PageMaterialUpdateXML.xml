<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baiyajin.materials.mapper.PageMaterialUpdateMapper">

    <!--钢材信息-->
    <sql id="getMaterialtPriceListMain">
        select m.c1,m.c2,m.c3,m.mname,m.mspec,m.munit,m.remark,m.mcid as mid,i.city,i.area,i.price,i.mdate
        from(
            select * from hl_main_material
            ) m
        left join
            (select * from hl_main_price where

             year(mdate) = year(#{mdate})
             <if test="type==0">
                and month(mdate) = month(#{mdate})
             </if>
            <if test="type==1">
                and quarter(mdate) = quarter(#{mdate})
             </if>
              ) i
        on m.mcid = i.mid  where i.id is not null
        union all
        select c1,c2,c3,mname,mspec,munit,remark,mid,city,area,price,mdate
        from
          material_price_info_update
        where 1=1
        and year(mdate) = year(#{mdate})
        <if test="type==0">
            and month(mdate) = month(#{mdate})
        </if>
        <if test="type==1">
            and quarter(mdate) = quarter(#{mdate})
        </if>
    </sql>

    <!--地区材料信息-->
    <sql id="getMaterialtPriceListPinfb">
        select m.c1,m.c2,m.c3,m.mname,m.mspec,m.munit,m.remark,m.id as mid,i.city,i.area,i.price,i.mtime as mdate
        from(
          select * from hl_pinfbase
           ) m
        left join
          (select * from hl_pinfb_price where
         year(mtime) = year(#{mdate})
        <if test="type==0">
            and month(mtime) = month(#{mdate})
        </if>
        <if test="type==1">
            and quarter(mtime) = quarter(#{mdate})
        </if>


              ) i
          on m.id = i.mid where i.id is not null
        union all
        select c1,c2,c3,mname,mspec,munit,remark,mid,city,area,price,mdate from material_price_info_update
        where 1=1
          and year(mdate) = year(#{mdate})
        <if test="type==0">
            and month(mdate) = month(#{mdate})
        </if>
        <if test="type==1">
            and quarter(mdate) = quarter(#{mdate})
        </if>

    </sql>



    <select id="getMaterialtPriceList" parameterType="com.baiyajin.entity.bean.PageMaterialUpdata"
            resultType="com.baiyajin.entity.bean.PageMaterialUpdata">
        <!--钢材信息-->
        <if test="mattype==0">
            <include refid="getMaterialtPriceListMain"></include>
        </if>
        <!--地区材料信息-->
        <if test="mattype==1">
            <include refid="getMaterialtPriceListPinfb"></include>
        </if>
    </select>



    <select id="getMaterialtAvgPrice" resultType="java.util.Map" parameterType="java.util.Map">
          select id,mid,city,area,avg(price) as price,mdate from (
            select id,mid,city,area,price,mtime as mdate
            from
              hl_pinfb_price where mid = #{mid} and area = #{area} and year(mtime) =#{year} and month(mtime)=#{month}
            union all
            select id,mid,city,area,price,mdate
            from
              hl_main_price where mid = #{mid} and area = #{area} and year(mdate) =#{year}  and month(mdate)=#{month}
            union all
            select id,mid,city,area,price,mdate
            from
              material_price_info_update where mid = #{mid} and area = #{area} and year(mdate) =#{year}  and month(mdate)=#{month}
          ) m group by mid,area,year(mdate),month(mdate)
  </select>



    <!--<update id="updateMaterialtPrice" parameterType="java.util.Map">-->
        <!--update page_material_pice-->
<!--set exponent = 195.900805793386000 / (exponent / 1000 * price)  * 1000-->
<!--where -->
<!--mid = 4  and area = 530102000000 and year(mdate) =2019  and month(mdate)=3-->
    <!--</update>-->

    <select id="getMaterialtPrice" resultType="com.baiyajin.entity.bean.PageMaterialPrice" parameterType="java.util.Map">
        select * from
          page_material_pice
        where
          mid = #{mid}
          and area = #{area}
          and year(mdate) = #{year}
          and month(mdate) = #{month}
          and type = 0
    </select>




    <select id="getMaterialtPriceByFilter" resultType="com.baiyajin.entity.bean.PageMaterialPrice" parameterType="java.util.Map">
        select * from
          page_material_pice
        where mid = #{mid}  and area = #{area} and type = #{type}
        <!--基价-->
        <if test="dateType==1">
            <![CDATA[
              and concat(year(mdate),month(mdate)) < concat(year(#{mdate}),month(#{mdate}))
            ]]>
            order by mdate  limit 1
        </if>
        <!--环比 -->
        <if test="dateType==2">
            <![CDATA[
                and concat(year(mdate),month(mdate)) < concat(year(#{mdate}),month(#{mdate}))
            ]]>
            order by mdate desc limit 1
        </if>
        <!--同比-->
        <if test="dateType==3">
            <![CDATA[
              and year(mdate) < year(#{mdate}) and month(mdate) = month(#{mdate})
            ]]>
            order by mdate asc  limit 1
        </if>
    </select>


    <select id="getMaterialCategory" resultType="com.baiyajin.entity.bean.MaterialCategory">
        select * from hlidx_category
    </select>



    <select id="getPinfbPrice" resultType="com.baiyajin.entity.bean.BasePrice"  parameterType="java.util.Map">
        select ANY_VALUE(c1) as c1,ANY_VALUE(c2) as c2, ANY_VALUE(c3) as c3,ANY_VALUE(mname) as mname,ANY_VALUE(munit) as munit,ANY_VALUE(mid) as mid,ANY_VALUE(city) as city,ANY_VALUE(area) as area,avg(price) as price,ANY_VALUE(mdate)  as mdate  from (
        select m.id,c1,c2,c3,mname,munit,mid,city,area,price,mtime as mdate from hl_pinfbase m
        right join
        (select id,mid,city,area,price,mtime from hl_pinfb_price where year(mtime) = #{year} and month(mtime) = #{month}) i
        on m.id = i.mid where c1 is not null
        ) mm group by c3,area
        union all
        select ANY_VALUE(c1) as c1,ANY_VALUE(c2) as c2, ANY_VALUE(c3) as c3,ANY_VALUE(mname) as mname,ANY_VALUE(munit) as munit,ANY_VALUE(mid) as mid,ANY_VALUE(city) as city,ANY_VALUE(area) as area,avg(price) as price,ANY_VALUE(mdate)  as mdate  from (
        select m.id,c1,c2,c3,mname,munit,mid,city,area,price,mdate as mdate from hl_main_material m
        right join
        (select id,mid,city,area,price,mdate from hl_main_price where year(mdate) =#{year} and month(mdate) =  #{month}) i
        on m.id = i.mid where c1 is not null
        ) mm group by c3,area
    </select>



    <select id="getPageMaterialPriceByQuarter" parameterType="java.util.Map" resultType="com.baiyajin.entity.bean.PageMaterialPrice">
        select
        ANY_VALUE( mid) as mid,ANY_VALUE(mat_name) as mat_name,ANY_VALUE(city) as city,ANY_VALUE(mat_pid) as mat_pid,ANY_VALUE(level) as level,ANY_VALUE(area) as area, ANY_VALUE(area_name) as area_name ,avg(price) as price,avg(exponent) as exponent,ANY_VALUE(tongbi) as tongbi,ANY_VALUE(huanbi) as huanbi,ANY_VALUE(mdate) as mdate,1 as type
        from
        page_material_pice
        where year(mdate)=#{year}
        <if test="quarter!=null and quarter!=0">
            and quarter(mdate)= #{quarter}
        </if>

        group by mid,area,year(mdate)
        <if test="quarter!=null and quarter!=0">
          ,quarter(mdate)
        </if>
    </select>

    <select id="getPageMaterialPriceByYear" parameterType="java.util.Map" resultType="com.baiyajin.entity.bean.PageMaterialPrice">
        select
        ANY_VALUE( mid) as mid,ANY_VALUE(mat_name) as mat_name,ANY_VALUE(city) as city,ANY_VALUE(mat_pid) as mat_pid,ANY_VALUE(level) as level,ANY_VALUE(area) as area, ANY_VALUE(area_name) as area_name ,avg(price) as price,avg(exponent) as exponent,ANY_VALUE(tongbi) as tongbi,ANY_VALUE(huanbi) as huanbi,ANY_VALUE(mdate) as mdate,2 as type
        from
        page_material_pice
        where year(mdate)=#{year}
        <if test="quarter!=null and quarter!=0">
            and quarter(mdate)= #{quarter}
        </if>
        group by mid,area,year(mdate)
        <if test="quarter!=null and quarter!=0">
            ,quarter(mdate)
        </if>
    </select>



    <insert id="saveUpdatelog" parameterType="java.util.Map" >
        insert into material_price_update_log(year,month)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.year},#{item.month})
        </foreach>
    </insert>

    <select id="selectUpdateLog" resultType="java.util.Map">
        select * from material_price_update_log
    </select>


</mapper>